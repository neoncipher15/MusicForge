import React, { useState } from 'react'
import { Plus, Trash2, Edit2, CheckCircle, Circle, Clock, Calendar, Search, Flag } from 'lucide-react'

interface Task {
  id: string
  title: string
  description: string
  estimatedPomodoros: number
  completedPomodoros: number
  priority: 'high' | 'medium' | 'low'
  dueDate: string | null
  completed: boolean
  completedAt?: Date
  createdAt: Date
  tags: string[]
}

const TasksPage: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([])
  const [newTaskTitle, setNewTaskTitle] = useState('')
  const [newTaskDescription, setNewTaskDescription] = useState('')
  const [newTaskEstPomodoros, setNewTaskEstPomodoros] = useState(1)
  const [newTaskPriority, setNewTaskPriority] = useState<'high' | 'medium' | 'low'>('medium')
  const [newTaskDueDate, setNewTaskDueDate] = useState('')
  const [newTaskTags, setNewTaskTags] = useState('')
  const [filter, setFilter] = useState<'all' | 'active' | 'completed'>('all')
  const [searchQuery, setSearchQuery] = useState('')
  const [editingTask, setEditingTask] = useState<string | null>(null)
  const [editTitle, setEditTitle] = useState('')
  const [showAddForm, setShowAddForm] = useState(false)

  const addTask = () => {
    if (!newTaskTitle.trim()) return
    const newTask: Task = {
      id: crypto.randomUUID(),
      title: newTaskTitle,
      description: newTaskDescription,
      estimatedPomodoros: newTaskEstPomodoros,
      completedPomodoros: 0,
      priority: newTaskPriority,
      dueDate: newTaskDueDate || null,
      completed: false,
      createdAt: new Date(),
      tags: newTaskTags.split(',').map(t => t.trim()).filter(Boolean)
    }
    setTasks(prev => [newTask, ...prev])
    setNewTaskTitle('')
    setNewTaskDescription('')
    setNewTaskEstPomodoros(1)
    setNewTaskPriority('medium')
    setNewTaskDueDate('')
    setNewTaskTags('')
    setShowAddForm(false)
  }

  const toggleTask = (taskId: string) => {
    setTasks(prev => prev.map(task =>
      task.id === taskId ? { ...task, completed: !task.completed, completedAt: new Date() } : task
    ))
  }

  const deleteTask = (taskId: string) => {
    setTasks(prev => prev.filter(task => task.id !== taskId))
  }

  const startEditing = (task: Task) => {
    setEditingTask(task.id)
    setEditTitle(task.title)
  }

  const saveEdit = (taskId: string) => {
    setTasks(prev => prev.map(task =>
      task.id === taskId ? { ...task, title: editTitle } : task
    ))
    setEditingTask(null)
    setEditTitle('')
  }

  const incrementPomodoro = (taskId: string) => {
    setTasks(prev => prev.map(task =>
      task.id === taskId ? { ...task, completedPomodoros: task.completedPomodoros + 1 } : task
    ))
  }

  const filteredTasks = tasks.filter(task => {
    const matchesFilter = filter === 'all' || (filter === 'active' && !task.completed) || (filter === 'completed' && task.completed)
    const matchesSearch = task.title.toLowerCase().includes(searchQuery.toLowerCase()) || task.tags.some(t => t.toLowerCase().includes(searchQuery.toLowerCase()))
    return matchesFilter && matchesSearch
  })

  const priorityColors = {
    high: 'bg-red-500/20 text-red-400 border-red-500/30',
    medium: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
    low: 'bg-green-500/20 text-green-400 border-green-500/30'
  }

  const completedTasks = tasks.filter(t => t.completed).length
  const totalTasks = tasks.length
  const totalEstimated = tasks.reduce((acc, t) => acc + t.estimatedPomodoros, 0)
  const totalCompletedPomodoros = tasks.reduce((acc, t) => acc + t.completedPomodoros, 0)

  return (
    <div className="animate-fade-in">
      <div className="flex items-center justify-between mb-8">
        <div><h1 className="text-3xl font-bold text-white mb-2">Tasks</h1><p className="text-gray-400">Manage your tasks and track progress</p></div>
        <button onClick={() => setShowAddForm(true)} className="flex items-center gap-2 px-6 py-3 bg-purple-500/20 text-purple-400 rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition-all duration-300 hover:scale-105"><Plus size={20} />Add Task</button>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-2"><div className="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center"><Circle size={20} className="text-blue-400" /></div></div><p className="text-2xl font-bold text-white">{totalTasks}</p><p className="text-sm text-gray-400">Total Tasks</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-2"><div className="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center"><CheckCircle size={20} className="text-green-400" /></div></div><p className="text-2xl font-bold text-white">{completedTasks}</p><p className="text-sm text-gray-400">Completed</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-2"><div className="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center"><Clock size={20} className="text-yellow-400" /></div></div><p className="text-2xl font-bold text-white">{totalEstimated - totalCompletedPomodoros}</p><p className="text-sm text-gray-400">Pomodoros Left</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-2"><div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center"><Flag size={20} className="text-purple-400" /></div></div><p className="text-2xl font-bold text-white">{totalCompletedPomodoros}</p><p className="text-sm text-gray-400">Pomodoros Done</p>
        </div>
      </div>

      {showAddForm && (
        <div className="mb-8 p-6 rounded-2xl bg-gray-800/50 border border-gray-700/50 animate-fade-in">
          <h3 className="text-lg font-semibold text-white mb-4">Add New Task</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" placeholder="Task title" value={newTaskTitle} onChange={(e) => setNewTaskTitle(e.target.value)} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500" />
            <input type="number" min="1" value={newTaskEstPomodoros} onChange={(e) => setNewTaskEstPomodoros(parseInt(e.target.value) || 1)} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-purple-500" />
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <select value={newTaskPriority} onChange={(e) => setNewTaskPriority(e.target.value as 'high' | 'medium' | 'low')} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-purple-500">
              <option value="low">Low Priority</option><option value="medium">Medium Priority</option><option value="high">High Priority</option>
            </select>
            <input type="date" value={newTaskDueDate} onChange={(e) => setNewTaskDueDate(e.target.value)} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-purple-500" />
            <input type="text" placeholder="Tags (comma separated)" value={newTaskTags} onChange={(e) => setNewTaskTags(e.target.value)} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500" />
          </div>
          <textarea placeholder="Description (optional)" value={newTaskDescription} onChange={(e) => setNewTaskDescription(e.target.value)} rows={3} className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 mb-4" />
          <div className="flex gap-3">
            <button onClick={addTask} className="px-6 py-3 bg-green-500/20 text-green-400 rounded-xl border border-green-500/30 hover:bg-green-500/30 transition-all">Add Task</button>
            <button onClick={() => setShowAddForm(false)} className="px-6 py-3 bg-gray-500/20 text-gray-400 rounded-xl border border-gray-500/30 hover:bg-gray-500/30 transition-all">Cancel</button>
          </div>
        </div>
      )}

      <div className="flex flex-col md:flex-row gap-4 mb-6">
        <div className="relative flex-1">
          <Search size={20} className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500" />
          <input type="text" placeholder="Search tasks..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-gray-800/50 border border-gray-700/50 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500" />
        </div>
        <div className="flex gap-2">
          {(['all', 'active', 'completed'] as const).map((f) => (
            <button key={f} onClick={() => setFilter(f)} className={`px-4 py-3 rounded-xl font-medium transition-all duration-300 capitalize ${filter === f ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-gray-800/50 text-gray-400 border border-gray-700/50 hover:bg-gray-700/50'}`}>{f}</button>
          ))}
        </div>
      </div>

      <div className="space-y-4">
        {filteredTasks.length === 0 ? (
          <div className="p-12 rounded-2xl bg-gray-800/50 border border-gray-700/50 text-center">
            <Calendar size={48} className="mx-auto text-gray-600 mb-4" /><p className="text-gray-400">No tasks found.</p><p className="text-gray-500 text-sm mt-2">Add a task to get started!</p>
          </div>
        ) : (
          filteredTasks.map((task) => (
            <div key={task.id} className={`p-5 rounded-2xl border transition-all duration-300 ${task.completed ? 'bg-gray-800/30 border-gray-700/30 opacity-60' : 'bg-gray-800/50 border-gray-700/50 hover:border-gray-600'}`}>
              <div className="flex items-start gap-4">
                <button onClick={() => toggleTask(task.id)} className={`mt-1 ${task.completed ? 'text-green-400' : 'text-gray-500 hover:text-green-400'} transition-colors`}>{task.completed ? <CheckCircle size={24} /> : <Circle size={24} />}</button>
                <div className="flex-1">
                  {editingTask === task.id ? (
                    <div className="flex gap-2">
                      <input type="text" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} className="flex-1 px-3 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500" />
                      <button onClick={() => saveEdit(task.id)} className="px-3 py-2 bg-green-500/20 text-green-400 rounded-lg">Save</button>
                      <button onClick={() => setEditingTask(null)} className="px-3 py-2 bg-gray-500/20 text-gray-400 rounded-lg">Cancel</button>
                    </div>
                  ) : (
                    <div>
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className={`font-semibold ${task.completed ? 'line-through text-gray-400' : 'text-white'}`}>{task.title}</h3>
                        <span className={`px-2 py-1 rounded-lg text-xs font-medium border ${priorityColors[task.priority]}`}>{task.priority}</span>
                      </div>
                      {task.description && <p className="text-gray-400 text-sm mb-3">{task.description}</p>}
                      <div className="flex items-center gap-4 text-sm">
                        <span className="flex items-center gap-1 text-gray-400"><Clock size={14} /> {task.completedPomodoros}/{task.estimatedPomodoros} pomodoros</span>
                        {task.dueDate && <span className="flex items-center gap-1 text-gray-400"><Calendar size={14} /> Due: {new Date(task.dueDate).toLocaleDateString()}</span>}
                        {task.tags.length > 0 && (
                          <div className="flex gap-1">{task.tags.map((tag) => (<span key={tag} className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">#{tag}</span>))}</div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  {!task.completed && (<button onClick={() => incrementPomodoro(task.id)} className="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors" title="Add pomodoro"><Plus size={18} /></button>)}
                  <button onClick={() => startEditing(task)} className="p-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors" title="Edit"><Edit2 size={18} /></button>
                  <button onClick={() => deleteTask(task.id)} className="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors" title="Delete"><Trash2 size={18} /></button>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  )
}

export default TasksPage

