import React, { useMemo } from 'react'
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell } from 'recharts'
import { TrendingUp, Clock, Target, Calendar, Flame, Award, Brain, Zap } from 'lucide-react'
import { usePomodoro } from '../context/PomodoroContext'

const AnalyticsPage: React.FC = () => {
  const { sessions, todayFocusTime, completedPomodoros } = usePomodoro()

  const weeklyData = useMemo(() => {
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
    const data = []
    for (let i = 6; i >= 0; i--) {
      const date = new Date()
      date.setDate(date.getDate() - i)
      const daySessions = sessions.filter(s => {
        const sessionDate = new Date(s.completedAt)
        return sessionDate.toDateString() === date.toDateString() && s.mode === 'focus'
      })
      const totalMinutes = daySessions.reduce((acc, s) => acc + s.duration, 0)
      data.push({ day: days[date.getDay()], pomodoros: daySessions.length, minutes: Math.round(totalMinutes / 60) })
    }
    return data
  }, [sessions])

  const hourlyData = useMemo(() => {
    const hours = Array.from({ length: 24 }, (_, i) => ({ hour: i, pomodoros: 0 }))
    sessions.filter(s => s.mode === 'focus').forEach(s => {
      const hour = new Date(s.completedAt).getHours()
      hours[hour].pomodoros++
    })
    return hours.filter(h => h.pomodoros > 0).slice(0, 12)
  }, [sessions])

  const modeDistribution = useMemo(() => {
    const focus = sessions.filter(s => s.mode === 'focus').length
    const shortBreak = sessions.filter(s => s.mode === 'shortBreak').length
    const longBreak = sessions.filter(s => s.mode === 'longBreak').length
    return [
      { name: 'Focus', value: focus, color: '#ef4444' },
      { name: 'Short Break', value: shortBreak, color: '#22c55e' },
      { name: 'Long Break', value: longBreak, color: '#3b82f6' }
    ]
  }, [sessions])

  const stats = useMemo(() => {
    const now = new Date()
    const todaySessions = sessions.filter(s => {
      const d = new Date(s.completedAt)
      return d.toDateString() === now.toDateString() && s.mode === 'focus'
    })
    const weekAgo = new Date()
    weekAgo.setDate(weekAgo.getDate() - 7)
    const weekSessions = sessions.filter(s => new Date(s.completedAt) >= weekAgo && s.mode === 'focus')
    const monthAgo = new Date()
    monthAgo.setDate(monthAgo.getDate() - 30)
    const monthSessions = sessions.filter(s => new Date(s.completedAt) >= monthAgo && s.mode === 'focus')
    
    const totalFocusMinutes = sessions.filter(s => s.mode === 'focus').reduce((acc, s) => acc + s.duration, 0)
    const avgPerSession = todaySessions.length > 0 ? Math.round(totalFocusMinutes / todaySessions.length / 60) : 0
    
    return {
      todayPomodoros: todaySessions.length,
      weekPomodoros: weekSessions.length,
      monthPomodoros: monthSessions.length,
      todayMinutes: Math.round(todaySessions.reduce((acc, s) => acc + s.duration, 0) / 60),
      weekMinutes: Math.round(weekSessions.reduce((acc, s) => acc + s.duration, 0) / 60),
      monthMinutes: Math.round(monthSessions.reduce((acc, s) => acc + s.duration, 0) / 60),
      avgSessionLength: avgPerSession,
      totalFocusHours: Math.round(totalFocusMinutes / 3600 * 10) / 10,
      streak: 5
    }
  }, [sessions])

  return (
    <div className="animate-fade-in">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-white mb-2">Analytics</h1>
        <p className="text-gray-400">Track your productivity and progress</p>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center"><Target size={20} className="text-red-400" /></div>
          </div>
          <p className="text-2xl font-bold text-white">{stats.todayPomodoros}</p>
          <p className="text-sm text-gray-400">Today\'s Pomodoros</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center"><Calendar size={20} className="text-blue-400" /></div>
          </div>
          <p className="text-2xl font-bold text-white">{stats.weekPomodoros}</p>
          <p className="text-sm text-gray-400">This Week</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center"><Clock size={20} className="text-green-400" /></div>
          </div>
          <p className="text-2xl font-bold text-white">{stats.todayMinutes}m</p>
          <p className="text-sm text-gray-400">Focus Time Today</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center"><Flame size={20} className="text-yellow-400" /></div>
          </div>
          <p className="text-2xl font-bold text-white">{stats.streak}</p>
          <p className="text-sm text-gray-400">Day Streak</p>
        </div>
      </div>

      {/* Weekly Chart */}
      <div className="mb-8 p-6 rounded-2xl bg-gray-800/50 border border-gray-700/50">
        <h2 className="text-xl font-semibold text-white mb-6">Weekly Progress</h2>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={weeklyData}>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
            <XAxis dataKey="day" stroke="#9ca3af" />
            <YAxis stroke="#9ca3af" />
            <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px' }} labelStyle={{ color: '#fff' }} />
            <Bar dataKey="pomodoros" fill="#a855f7" radius={[4, 4, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        {/* Hourly Distribution */}
        <div className="p-6 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <h2 className="text-xl font-semibold text-white mb-6">Peak Hours</h2>
          <ResponsiveContainer width="100%" height={250}>
            <LineChart data={hourlyData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
              <XAxis dataKey="hour" stroke="#9ca3af" tickFormatter={(v) => `${v}:00`} />
              <YAxis stroke="#9ca3af" />
              <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px' }} labelFormatter={(v) => `${v}:00`} />
              <Line type="monotone" dataKey="pomodoros" stroke="#22c55e" strokeWidth={2} dot={{ fill: '#22c55e' }} />
            </LineChart>
          </ResponsiveContainer>
        </div>

        {/* Mode Distribution */}
        <div className="p-6 rounded-2xl bg-gray-800/50 border border-gray-700/50">
          <h2 className="text-xl font-semibold text-white mb-6">Session Distribution</h2>
          <ResponsiveContainer width="100%" height={250}>
            <PieChart>
              <Pie data={modeDistribution} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={5} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                {modeDistribution.map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.color} />))}
              </Pie>
              <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px' }} />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Additional Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50 text-center">
          <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mx-auto mb-3"><Award size={24} className="text-purple-400" /></div>
          <p className="text-2xl font-bold text-white">{stats.monthPomodoros}</p>
          <p className="text-sm text-gray-400">This Month</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50 text-center">
          <div className="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center mx-auto mb-3"><Clock size={24} className="text-green-400" /></div>
          <p className="text-2xl font-bold text-white">{stats.weekMinutes}m</p>
          <p className="text-sm text-gray-400">Weekly Focus</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50 text-center">
          <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center mx-auto mb-3"><Brain size={24} className="text-blue-400" /></div>
          <p className="text-2xl font-bold text-white">{stats.avgSessionLength}m</p>
          <p className="text-sm text-gray-400">Avg Session</p>
        </div>
        <div className="p-5 rounded-2xl bg-gray-800/50 border border-gray-700/50 text-center">
          <div className="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center mx-auto mb-3"><Zap size={24} className="text-yellow-400" /></div>
          <p className="text-2xl font-bold text-white">{stats.totalFocusHours}h</p>
          <p className="text-sm text-gray-400">Total Focus</p>
        </div>
      </div>
    </div>
  )
}

export default AnalyticsPage

